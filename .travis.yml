dist: trusty
sudo: required
cache:
  directories:
  - "$HOME/.ghc"
  - "$HOME/.cabal"
  - "$HOME/.stack"
matrix:
  include:
  - env: BUILD=stack ARGS=""
    compiler: ": #stack 8.0.1"
    addons:
      apt:
        packages:
        - ghc-8.0.1
        - mysql-server-5.6
        - mysql-client-core-5.6
        - mysql-client-5.6
        sources:
        - hvr-ghc
  fast_finish: true
before_install:
- unset CC
- CABALARGS=""
- if [ "x$GHCVER" = "xhead" ]; then CABALARGS=--allow-newer; fi
- sudo dd if=/dev/zero of=/swapfile bs=1M count=1024
- sudo mkswap /swapfile
- sudo swapon /swapfile
- export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$HOME/.local/bin:$PATH
- mkdir -p ~/.local/bin
- |
  if [ `uname` = "Darwin" ]
  then
    curl --insecure -L https://www.stackage.org/stack/osx-x86_64 | tar xz --strip-components=1 --include '*/stack' -C ~/.local/bin
  else
    curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'
  fi
install:
- echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo
  '?')]"
- chmod +x ./travis_long
- if [ -f configure.ac ]; then autoreconf -i; fi
- PATH=$PATH:~/.cabal/bin
- "case \"$BUILD\" in\n  stack)\n    stack --no-terminal --install-ghc $ARGS test
  --only-dependencies\n    ;;\n  cabal)\n    cabal --version\n    travis_retry cabal
  update\n    cabal install --enable-tests \n    ;;\nesac\n"
- mkdir -p dist/bin

before_script: composer install

script:
- |
  case "$BUILD" in
    stack)
    ./travis_long stack --no-terminal --local-bin-path=dist/bin --copy-bins --test $ARGS build
      ;;
    cabal)
    ./travis_long cabal test
      ;;
  esac

deploy:
  provider: releases
  api_key:
    secure: Lzpil1RjuIpOYrpfMQYdIbwmFoylGbvoZLUpEZebUrpWWl/st31J9LwR2WosdjgGBogOQPz9eybjtHPdzJ+mCwOxJUb1HHKhwWYt9H+Gh2n7k9md652SjTLQkEtjcb9XK9qnrhmG9AY/y6ZQNcTV+iFaB9PwznGT4KfFPeOLIRGAbROV9SLJuC+ps4Bq8k/rzeilDt/IYQhdZAzQnc8ejyZG6WJRWpM1RFIQoYCMUSZSSsmL9y50XPMtTXZae+BErGSRzUojz9IiXsPFKETsuhOCCMKGKEwg8XrUYnn/4Yy7xsb6JgjookNPAlD7ga+jVRiHcnX2ZmQa1wdjy+F0H36vzkHTJUKmndGrd948213Pk4h6zDMt5AmOcyRlLzjBZvIUuEn3vYSbbbiTyf1N2DzzuTGl6gUeTd129rpPMuBLM1byGXq5HQnTMxFCGq1Aj7G7ClJ7eHGKHVykk2pH8aFgMwYlUDxPt9lVABDTIRjphgPdSETphXdaJD0hT2GDwfZ1mQjlvy/zdQFkH4y21oxw4sv4AuEFLAhafZPTtrijiG5jainlHplpjGAf1R84gtQ67Ac5xdW4NsBv3LyQz27e+ebOf4gmOF238FZzoq9WfQnxS4gH01PbqT6L3MldgTH8W+I99hFJm0OvbaIJwpdBDBVUFRAqVubi4kxRqhk=
  file: "dist/bin/ampersand"
  on:
    repo: hidde-jan/Ampersand
    tags: true
    condition: $BUILD = stack
